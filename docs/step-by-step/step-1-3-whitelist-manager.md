# Step 1.3: ç™½åå•ç®¡ç†åˆçº¦

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å®ç°çµæ´»çš„ç™½åå•ç®¡ç†ç³»ç»Ÿï¼Œä¸ºä¼—ç­¹å¹³å°æä¾›åˆ†å±‚ç”¨æˆ·ç®¡ç†åŠŸèƒ½ã€‚è¯¥åˆçº¦å°†æ”¯æŒæ‰¹é‡æ“ä½œã€åˆ†å±‚æƒé™ã€æ—¶é—´æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ï¼Œä¸ºåç»­çš„é¢„å”®é˜¶æ®µå’ŒVIPç”¨æˆ·ç®¡ç†æä¾›åŸºç¡€è®¾æ–½ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

- âœ… Step 1.2 å·²å®Œæˆï¼ˆERC20ä»£å¸åˆçº¦å¼€å‘ï¼‰
- âœ… CrowdsaleToken åˆçº¦å·²éƒ¨ç½²å¹¶æµ‹è¯•é€šè¿‡
- âœ… OpenZeppelin è®¿é—®æ§åˆ¶åº“å¯ç”¨

## ğŸ”§ æŠ€æœ¯æ ˆå’Œä¾èµ–

### æ ¸å¿ƒä¾èµ–
- **@openzeppelin/contracts/access** - è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†
- **@openzeppelin/contracts/utils** - å·¥å…·åº“å’Œæ•°æ®ç»“æ„
- **@openzeppelin/contracts/security** - é‡å…¥ä¿æŠ¤å’Œå®‰å…¨æœºåˆ¶
- **Solidity ^0.8.19** - æ™ºèƒ½åˆçº¦å¼€å‘è¯­è¨€

### åˆçº¦ç‰¹æ€§
- **åˆ†å±‚ç™½åå•** - æ”¯æŒå¤šçº§ç”¨æˆ·æƒé™ï¼ˆVIPã€æ™®é€šã€é»‘åå•ï¼‰
- **æ‰¹é‡æ“ä½œ** - é«˜æ•ˆçš„æ‰¹é‡æ·»åŠ /ç§»é™¤åŠŸèƒ½
- **æ—¶é—´æ§åˆ¶** - ç™½åå•è¿‡æœŸæ—¶é—´ç®¡ç†
- **è½¬ç§»åŠŸèƒ½** - ç™½åå•æƒé™è½¬ç§»æœºåˆ¶
- **æŸ¥è¯¢ä¼˜åŒ–** - å¿«é€ŸçŠ¶æ€æŸ¥è¯¢å’Œç»Ÿè®¡åŠŸèƒ½

## ğŸ—ï¸ ç™½åå•æ¶æ„è®¾è®¡

### ç”¨æˆ·å±‚çº§å®šä¹‰
```
BLACKLISTED (0) - é»‘åå•ç”¨æˆ·ï¼Œç¦æ­¢å‚ä¸
NONE (1)        - æ™®é€šç”¨æˆ·ï¼Œæ— ç‰¹æ®Šæƒé™
WHITELISTED (2) - ç™½åå•ç”¨æˆ·ï¼Œå¯å‚ä¸é¢„å”®
VIP (3)         - VIPç”¨æˆ·ï¼Œäº«å—ç‰¹æ®Šä»·æ ¼å’Œé¢åº¦
```

### æ ¸å¿ƒæ•°æ®ç»“æ„
- **ç”¨æˆ·çŠ¶æ€æ˜ å°„** - è®°å½•æ¯ä¸ªåœ°å€çš„ç™½åå•çº§åˆ«
- **è¿‡æœŸæ—¶é—´æ§åˆ¶** - æ”¯æŒç™½åå•æ—¶é—´é™åˆ¶
- **æ‰¹é‡æ“ä½œä¼˜åŒ–** - å‡å°‘Gasæ¶ˆè€—çš„å­˜å‚¨è®¾è®¡
- **äº‹ä»¶æ—¥å¿—ç³»ç»Ÿ** - å®Œæ•´çš„æ“ä½œè®°å½•

## ğŸ“Š ç™½åå•ç­–ç•¥è®¾è®¡

### åˆ†å±‚æƒé™ä½“ç³»
- **VIPç”¨æˆ· (Level 3)**
  - æœ€æ—©å‚ä¸é¢„å”®æƒé™
  - äº«å—æœ€ä¼˜æƒ ä»·æ ¼ï¼ˆå¦‚8æŠ˜ï¼‰
  - æ›´é«˜çš„è´­ä¹°é™é¢
  - ä¸“å±å®¢æœæ”¯æŒ

- **ç™½åå•ç”¨æˆ· (Level 2)**
  - é¢„å”®é˜¶æ®µå‚ä¸æƒé™
  - æ ‡å‡†ä¼˜æƒ ä»·æ ¼ï¼ˆå¦‚9æŠ˜ï¼‰
  - æ ‡å‡†è´­ä¹°é™é¢
  - ä¼˜å…ˆå®¢æœæ”¯æŒ

- **æ™®é€šç”¨æˆ· (Level 1)**
  - ä»…å…¬å”®é˜¶æ®µå‚ä¸
  - æ ‡å‡†ä»·æ ¼
  - åŸºç¡€è´­ä¹°é™é¢

- **é»‘åå•ç”¨æˆ· (Level 0)**
  - å®Œå…¨ç¦æ­¢å‚ä¸
  - ç”¨äºé£é™©æ§åˆ¶

### æ—¶é—´æ§åˆ¶æœºåˆ¶
- **æ°¸ä¹…ç™½åå•** - æ— è¿‡æœŸæ—¶é—´é™åˆ¶
- **ä¸´æ—¶ç™½åå•** - è®¾ç½®å…·ä½“è¿‡æœŸæ—¶é—´
- **åŠ¨æ€è°ƒæ•´** - ç®¡ç†å‘˜å¯éšæ—¶ä¿®æ”¹çŠ¶æ€
- **è‡ªåŠ¨æ¸…ç†** - è¿‡æœŸçŠ¶æ€è‡ªåŠ¨å¤„ç†

## ğŸš€ è¯¦ç»†å®ç°æ­¥éª¤

### Step 1: åˆ›å»ºç™½åå•æ¥å£

é¦–å…ˆå®šä¹‰æ ‡å‡†åŒ–çš„ç™½åå•ç®¡ç†æ¥å£ï¼š

```bash
# åˆ›å»ºæ¥å£æ–‡ä»¶
touch contracts/interfaces/IWhitelistManager.sol
```

**ä¸»è¦æ¥å£åŠŸèƒ½**ï¼š
- `addToWhitelist(address user, uint8 level)` - æ·»åŠ ç™½åå•ç”¨æˆ·
- `removeFromWhitelist(address user)` - ç§»é™¤ç™½åå•ç”¨æˆ·
- `batchAddToWhitelist(address[] users, uint8[] levels)` - æ‰¹é‡æ·»åŠ 
- `getWhitelistStatus(address user)` - æŸ¥è¯¢ç”¨æˆ·çŠ¶æ€
- `isWhitelisted(address user)` - æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•
- `transferWhitelistStatus(address from, address to)` - è½¬ç§»ç™½åå•çŠ¶æ€

### Step 2: å®ç°ç™½åå•ç®¡ç†åˆçº¦

åˆ›å»ºæ ¸å¿ƒçš„ç™½åå•ç®¡ç†åˆçº¦ï¼š

```bash
# åˆ›å»ºä¸»åˆçº¦æ–‡ä»¶
touch contracts/WhitelistManager.sol
```

**æ ¸å¿ƒåŠŸèƒ½å®ç°**ï¼š
- ç»§æ‰¿ AccessControl å’Œ ReentrancyGuard
- å®ç°åˆ†å±‚ç™½åå•ç®¡ç†
- æ·»åŠ æ‰¹é‡æ“ä½œä¼˜åŒ–
- å®ç°æ—¶é—´æ§åˆ¶æœºåˆ¶
- æ·»åŠ ç»Ÿè®¡å’ŒæŸ¥è¯¢åŠŸèƒ½

### Step 3: åˆ›å»ºéƒ¨ç½²è„šæœ¬

```bash
# åˆ›å»ºéƒ¨ç½²è„šæœ¬
touch script/DeployWhitelist.s.sol
```

**éƒ¨ç½²è„šæœ¬åŠŸèƒ½**ï¼š
- éƒ¨ç½²ç™½åå•ç®¡ç†åˆçº¦
- è®¾ç½®åˆå§‹ç®¡ç†å‘˜æƒé™
- é…ç½®åŸºç¡€å‚æ•°
- éªŒè¯éƒ¨ç½²ç»“æœ

### Step 4: åˆ›å»ºå®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
touch test/unit/WhitelistManager.t.sol
touch test/fuzz/WhitelistFuzz.t.sol
```

**æµ‹è¯•è¦†ç›–èŒƒå›´**ï¼š
- åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼ˆæ·»åŠ ã€ç§»é™¤ã€æŸ¥è¯¢ï¼‰
- æ‰¹é‡æ“ä½œæµ‹è¯•
- æƒé™æ§åˆ¶æµ‹è¯•
- æ—¶é—´æ§åˆ¶æµ‹è¯•
- è½¬ç§»åŠŸèƒ½æµ‹è¯•
- Gasä¼˜åŒ–éªŒè¯
- æ¨¡ç³Šæµ‹è¯•ï¼ˆè¾¹ç•Œæ¡ä»¶ï¼‰

## ğŸ“‹ è¾“å‡ºäº¤ä»˜ç‰©

å®Œæˆ Step 1.3 åï¼Œåº”è¯¥åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

### âœ… åˆçº¦æ–‡ä»¶
- [ ] `contracts/WhitelistManager.sol` - ä¸»ç™½åå•ç®¡ç†åˆçº¦
- [ ] `contracts/interfaces/IWhitelistManager.sol` - ç™½åå•æ¥å£å®šä¹‰

### âœ… æµ‹è¯•æ–‡ä»¶
- [ ] `test/unit/WhitelistManager.t.sol` - å®Œæ•´å•å…ƒæµ‹è¯•å¥—ä»¶
- [ ] `test/fuzz/WhitelistFuzz.t.sol` - æ¨¡ç³Šæµ‹è¯•å¥—ä»¶

### âœ… éƒ¨ç½²è„šæœ¬
- [ ] `script/DeployWhitelist.s.sol` - ç™½åå•åˆçº¦éƒ¨ç½²è„šæœ¬

### âœ… æ–‡æ¡£
- [ ] `docs/step-by-step/step-1-3-whitelist-manager.md` - æœ¬æ­¥éª¤è¯¦ç»†æ–‡æ¡£

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. ç¼–è¯‘éªŒè¯
```bash
# ç¼–è¯‘åˆçº¦
make build
# æœŸæœ›è¾“å‡º: ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

### 2. æµ‹è¯•éªŒè¯
```bash
# è¿è¡Œç™½åå•æµ‹è¯•
forge test --match-contract WhitelistManager
# è¿è¡Œæ¨¡ç³Šæµ‹è¯•
forge test --match-contract WhitelistFuzz
# æœŸæœ›è¾“å‡º: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œè¦†ç›–ç‡>95%
```

### 3. éƒ¨ç½²éªŒè¯
```bash
# éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ
forge script script/DeployWhitelist.s.sol --rpc-url http://localhost:8545 --broadcast
# æœŸæœ›è¾“å‡º: éƒ¨ç½²æˆåŠŸï¼Œè¿”å›åˆçº¦åœ°å€
```

### 4. åŠŸèƒ½éªŒè¯
```bash
# æµ‹è¯•æ·»åŠ ç™½åå•
cast send <WHITELIST_ADDRESS> "addToWhitelist(address,uint8)" <USER_ADDRESS> 2 --rpc-url http://localhost:8545 --private-key <PRIVATE_KEY>

# æµ‹è¯•æŸ¥è¯¢çŠ¶æ€
cast call <WHITELIST_ADDRESS> "getWhitelistStatus(address)" <USER_ADDRESS> --rpc-url http://localhost:8545
```

### 5. Gasä¼˜åŒ–éªŒè¯
```bash
# è¿è¡ŒGasæŠ¥å‘Š
forge test --gas-report --match-contract WhitelistManager
# éªŒè¯æ‰¹é‡æ“ä½œç›¸æ¯”å•ä¸ªæ“ä½œèŠ‚çœ>30% Gas
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: æ‰¹é‡æ“ä½œGasæ¶ˆè€—è¿‡é«˜

**ç—‡çŠ¶**: æ‰¹é‡æ·»åŠ å¤§é‡ç”¨æˆ·æ—¶äº¤æ˜“å¤±è´¥æˆ–Gasæ¶ˆè€—è¶…å‡ºé¢„æœŸ

**è§£å†³æ–¹æ¡ˆ**:
- é™åˆ¶å•æ¬¡æ‰¹é‡æ“ä½œçš„æ•°é‡ï¼ˆå»ºè®®â‰¤100ï¼‰
- ä¼˜åŒ–å­˜å‚¨ç»“æ„ï¼Œä½¿ç”¨packed struct
- å®ç°åˆ†æ‰¹å¤„ç†æœºåˆ¶

### é—®é¢˜2: æƒé™æ§åˆ¶å†²çª

**ç—‡çŠ¶**: å¤šä¸ªç®¡ç†å‘˜åŒæ—¶æ“ä½œå¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**:
- å®ç°æ“ä½œé”å®šæœºåˆ¶
- æ·»åŠ æ“ä½œæ—¥å¿—å’Œå®¡è®¡åŠŸèƒ½
- ä½¿ç”¨äº‹ä»¶è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ

### é—®é¢˜3: æ—¶é—´æ§åˆ¶ç²¾åº¦é—®é¢˜

**ç—‡çŠ¶**: ç™½åå•è¿‡æœŸæ—¶é—´åˆ¤æ–­ä¸å‡†ç¡®

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨block.timestampè€Œéblock.number
- æ·»åŠ æ—¶é—´ç¼“å†²åŒºé¿å…è¾¹ç•Œé—®é¢˜
- å®ç°è‡ªåŠ¨æ¸…ç†æœºåˆ¶

## ğŸ’¡ æœ€ä½³å®è·µæé†’

- **Gasä¼˜åŒ–**: ä¼˜å…ˆè€ƒè™‘æ‰¹é‡æ“ä½œï¼Œå‡å°‘å•ç‹¬äº¤æ˜“
- **æƒé™åˆ†ç¦»**: åˆç†è®¾è®¡ç®¡ç†å‘˜æƒé™ï¼Œé¿å…æƒé™è¿‡åº¦é›†ä¸­
- **äº‹ä»¶è®°å½•**: ä¸ºæ‰€æœ‰çŠ¶æ€å˜æ›´æ·»åŠ è¯¦ç»†äº‹ä»¶æ—¥å¿—
- **è¾¹ç•Œæ£€æŸ¥**: ä¸¥æ ¼éªŒè¯è¾“å…¥å‚æ•°ï¼Œé˜²æ­¢æ— æ•ˆæ“ä½œ
- **å‡çº§å…¼å®¹**: é¢„ç•™æ¥å£æ‰©å±•ç©ºé—´ï¼Œæ”¯æŒæœªæ¥åŠŸèƒ½å‡çº§

## ğŸ”— ä¸å…¶ä»–åˆçº¦çš„é›†æˆ

### ä¸ CrowdsaleToken çš„é›†æˆ
- ç™½åå•åˆçº¦å°†è¢«ä¼—ç­¹åˆçº¦è°ƒç”¨
- æä¾›ç”¨æˆ·æƒé™éªŒè¯æ¥å£
- æ”¯æŒåŠ¨æ€æƒé™æŸ¥è¯¢

### ä¸ºåç»­åˆçº¦é¢„ç•™æ¥å£
- ä¼—ç­¹åˆçº¦å°†ä¾èµ–ç™½åå•çŠ¶æ€
- ä»£å¸é‡Šæ”¾åˆçº¦å¯èƒ½éœ€è¦ç™½åå•ä¿¡æ¯
- æ²»ç†åˆçº¦å¯èƒ½éœ€è¦æŠ•ç¥¨æƒé™æ§åˆ¶

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

å®Œæˆ Step 1.3 åï¼Œå¼€å‘è€…åº”è¯¥ï¼š

1. **é›†æˆæµ‹è¯•**: æµ‹è¯•ç™½åå•ä¸ä»£å¸åˆçº¦çš„ååŒå·¥ä½œ
2. **æ€§èƒ½ä¼˜åŒ–**: åˆ†æGasæ¶ˆè€—ï¼Œä¼˜åŒ–æ‰¹é‡æ“ä½œ
3. **å®‰å…¨å®¡æŸ¥**: æ£€æŸ¥æƒé™æ§åˆ¶å’Œè¾¹ç•Œæ¡ä»¶
4. **å‡†å¤‡ä¸‹ä¸€æ­¥**: å¼€å§‹ Step 2.1 - ä¼—ç­¹ä¸»åˆçº¦æ¶æ„è®¾è®¡

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡ç›®æ ‡

- **æ‰¹é‡æ“ä½œæ•ˆç‡**: ç›¸æ¯”å•ä¸ªæ“ä½œèŠ‚çœ >30% Gas
- **æŸ¥è¯¢å“åº”æ—¶é—´**: å•æ¬¡æŸ¥è¯¢ <50,000 Gas
- **å­˜å‚¨ä¼˜åŒ–**: æ¯ä¸ªç”¨æˆ·çŠ¶æ€å­˜å‚¨ <1 slot
- **æµ‹è¯•è¦†ç›–ç‡**: >95% ä»£ç è¦†ç›–ç‡
- **æ¨¡ç³Šæµ‹è¯•**: é€šè¿‡ 1000+ éšæœºè¾“å…¥æµ‹è¯•

---

**Git Commit**: `feat: implement whitelist manager with batch operations and gas optimization`

**å®ŒæˆçŠ¶æ€**: â³ Step 1.3 - ç™½åå•ç®¡ç†åˆçº¦å¼€å‘è¿›è¡Œä¸­

**ä¸‹ä¸€æ­¥**: [Step 2.1: ä¼—ç­¹ä¸»åˆçº¦æ¶æ„](step-2-1-crowdsale-architecture.md)
