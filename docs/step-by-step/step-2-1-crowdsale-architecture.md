# Step 2.1: ä¼—ç­¹ä¸»åˆçº¦æž¶æž„

## ðŸ“‹ æ¦‚è¿°

**åŠŸèƒ½ç›®æ ‡**: å®žçŽ°ä¼—ç­¹åˆçº¦çš„æ ¸å¿ƒæž¶æž„å’ŒçŠ¶æ€ç®¡ç†  
**å‰ç½®æ¡ä»¶**: Step 1.3 (WhitelistManager) å®Œæˆ  
**è¾“å…¥ä¾èµ–**: OpenZeppelin Securityå’ŒMathåº“  

## ðŸŽ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒåŠŸèƒ½
- **å¤šé˜¶æ®µä¼—ç­¹ç®¡ç†**: é¢„å”® â†’ å…¬å”® â†’ ç»“æŸçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- **çŠ¶æ€æœºè®¾è®¡**: ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢æŽ§åˆ¶å’ŒéªŒè¯
- **æ—¶é—´æŽ§åˆ¶æœºåˆ¶**: åŸºäºŽåŒºå—æ—¶é—´çš„ç²¾ç¡®æŽ§åˆ¶
- **èµ„é‡‘ç›®æ ‡ç®¡ç†**: è½¯é¡¶/ç¡¬é¡¶ç›®æ ‡è®¾ç½®å’Œç›‘æŽ§
- **æƒé™æŽ§åˆ¶ç³»ç»Ÿ**: åˆ†å±‚æƒé™ç®¡ç†å’Œæ“ä½œæŽ§åˆ¶
- **ç´§æ€¥æŽ§åˆ¶æœºåˆ¶**: æš‚åœ/æ¢å¤åŠŸèƒ½ä¿éšœå®‰å…¨

### æž¶æž„åŽŸåˆ™
- **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„èŒè´£åˆ†ç¦»å’ŒæŽ¥å£å®šä¹‰
- **å¯æ‰©å±•æ€§**: é¢„ç•™æ‰©å±•æŽ¥å£æ”¯æŒæœªæ¥åŠŸèƒ½
- **å®‰å…¨ç¬¬ä¸€**: å¤šé‡å®‰å…¨æ£€æŸ¥å’Œé˜²æŠ¤æœºåˆ¶
- **Gasä¼˜åŒ–**: é«˜æ•ˆçš„å­˜å‚¨å¸ƒå±€å’Œè®¡ç®—é€»è¾‘
- **äº‹ä»¶é©±åŠ¨**: å®Œæ•´çš„äº‹ä»¶è®°å½•ä¾¿äºŽç›‘æŽ§

## ðŸ—ï¸ æž¶æž„è®¾è®¡

### çŠ¶æ€æœºè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    startCrowdsale()    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PENDING   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  PRESALE    â”‚
â”‚   (åˆå§‹)     â”‚                        â”‚   (é¢„å”®)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â”‚ startPublicSale()
                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    finalize()          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FINALIZED  â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ PUBLIC_SALE â”‚
â”‚   (å·²ç»“æŸ)   â”‚                        â”‚   (å…¬å”®)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²                                      â”‚
       â”‚                                      â”‚ 
       â””â”€â”€â”€â”€â”€â”€â”€â”€ emergencyStop() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆçº¦æž¶æž„å±‚æ¬¡

```
TokenCrowdsale (ä¸»åˆçº¦)
â”œâ”€â”€ ICrowdsale (æŽ¥å£å®šä¹‰)
â”œâ”€â”€ CrowdsaleConstants (å¸¸é‡å®šä¹‰)  
â”œâ”€â”€ AccessControl (æƒé™ç®¡ç†)
â”œâ”€â”€ Pausable (æš‚åœæœºåˆ¶)
â”œâ”€â”€ ReentrancyGuard (é‡å…¥é˜²æŠ¤)
â””â”€â”€ é›†æˆåˆçº¦:
    â”œâ”€â”€ CrowdsaleToken (ERC20ä»£å¸)
    â””â”€â”€ WhitelistManager (ç™½åå•ç®¡ç†)
```

## ðŸ“Š æ ¸å¿ƒç»„ä»¶

### 1. ä¼—ç­¹é˜¶æ®µæžšä¸¾

```solidity
enum CrowdsalePhase {
    PENDING,        // 0: å¾…å¼€å§‹
    PRESALE,        // 1: é¢„å”®é˜¶æ®µ
    PUBLIC_SALE,    // 2: å…¬å”®é˜¶æ®µ  
    FINALIZED       // 3: å·²ç»“æŸ
}
```

### 2. ä¼—ç­¹é…ç½®ç»“æž„

```solidity
struct CrowdsaleConfig {
    uint256 presaleStartTime;     // é¢„å”®å¼€å§‹æ—¶é—´
    uint256 presaleEndTime;       // é¢„å”®ç»“æŸæ—¶é—´
    uint256 publicSaleStartTime;  // å…¬å”®å¼€å§‹æ—¶é—´
    uint256 publicSaleEndTime;    // å…¬å”®ç»“æŸæ—¶é—´
    uint256 softCap;              // è½¯é¡¶ç›®æ ‡ (æœ€å°ç­¹èµ„ç›®æ ‡)
    uint256 hardCap;              // ç¡¬é¡¶ç›®æ ‡ (æœ€å¤§ç­¹èµ„ç›®æ ‡)
    uint256 minPurchase;          // æœ€å°è´­ä¹°é‡‘é¢
    uint256 maxPurchase;          // æœ€å¤§è´­ä¹°é‡‘é¢
}
```

### 3. ä¼—ç­¹çŠ¶æ€è·Ÿè¸ª

```solidity
struct CrowdsaleStats {
    uint256 totalRaised;         // æ€»ç­¹èµ„é‡‘é¢
    uint256 totalTokensSold;     // æ€»å”®å‡ºä»£å¸æ•°é‡
    uint256 participantCount;    // å‚ä¸Žäººæ•°
    uint256 presaleRaised;       // é¢„å”®ç­¹èµ„é‡‘é¢
    uint256 publicSaleRaised;    // å…¬å”®ç­¹èµ„é‡‘é¢
}
```

## ðŸ”§ æ ¸å¿ƒåŠŸèƒ½å®žçŽ°

### 1. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

**çŠ¶æ€è½¬æ¢æŽ§åˆ¶**:
- ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢éªŒè¯
- æ—¶é—´çª—å£æ£€æŸ¥
- æƒé™éªŒè¯
- æ¡ä»¶æ»¡è¶³æ£€æŸ¥

**å…³é”®ä¿®é¥°ç¬¦**:
- `onlyInPhase(CrowdsalePhase _phase)`: é˜¶æ®µæ£€æŸ¥
- `onlyValidTransition(CrowdsalePhase _from, CrowdsalePhase _to)`: è½¬æ¢éªŒè¯
- `withinTimeWindow()`: æ—¶é—´çª—å£éªŒè¯

### 2. æ—¶é—´æŽ§åˆ¶æœºåˆ¶

**æ—¶é—´ç®¡ç†**:
- åŸºäºŽ `block.timestamp` çš„ç²¾ç¡®æ—¶é—´æŽ§åˆ¶
- é¢„å”®å’Œå…¬å”®æ—¶é—´çª—å£ç®¡ç†
- è‡ªåŠ¨é˜¶æ®µè½¬æ¢è§¦å‘
- æ—¶é—´è¾¹ç•ŒéªŒè¯

**æ—¶é—´éªŒè¯é€»è¾‘**:
```solidity
modifier withinTimeWindow() {
    if (currentPhase == CrowdsalePhase.PRESALE) {
        require(
            block.timestamp >= config.presaleStartTime && 
            block.timestamp <= config.presaleEndTime,
            "Not in presale time window"
        );
    }
    // å…¶ä»–é˜¶æ®µçš„æ—¶é—´éªŒè¯...
    _;
}
```

### 3. èµ„é‡‘ç›®æ ‡ç®¡ç†

**è½¯é¡¶/ç¡¬é¡¶æœºåˆ¶**:
- **è½¯é¡¶ (Soft Cap)**: æœ€å°æˆåŠŸç­¹èµ„ç›®æ ‡
- **ç¡¬é¡¶ (Hard Cap)**: æœ€å¤§ç­¹èµ„ä¸Šé™
- å®žæ—¶ç›®æ ‡è¾¾æˆæ£€æŸ¥
- è‡ªåŠ¨ç»“æŸè§¦å‘æ¡ä»¶

**ç›®æ ‡æ£€æŸ¥é€»è¾‘**:
- è¾¾åˆ°ç¡¬é¡¶è‡ªåŠ¨ç»“æŸä¼—ç­¹
- è½¯é¡¶æœªè¾¾æˆè§¦å‘é€€æ¬¾æœºåˆ¶
- å®žæ—¶è¿›åº¦è®¡ç®—å’Œæ›´æ–°

### 4. æƒé™æŽ§åˆ¶ç³»ç»Ÿ

**è§’è‰²å®šä¹‰**:
```solidity
bytes32 public constant CROWDSALE_ADMIN_ROLE = keccak256("CROWDSALE_ADMIN_ROLE");
bytes32 public constant CROWDSALE_OPERATOR_ROLE = keccak256("CROWDSALE_OPERATOR_ROLE");
bytes32 public constant EMERGENCY_ROLE = keccak256("EMERGENCY_ROLE");
```

**æƒé™åˆ†é…**:
- **CROWDSALE_ADMIN_ROLE**: ä¼—ç­¹é…ç½®å’Œç®¡ç†
- **CROWDSALE_OPERATOR_ROLE**: æ—¥å¸¸æ“ä½œå’Œç›‘æŽ§  
- **EMERGENCY_ROLE**: ç´§æ€¥æš‚åœå’Œæ¢å¤

## ðŸ›¡ï¸ å®‰å…¨æœºåˆ¶

### 1. é‡å…¥æ”»å‡»é˜²æŠ¤
- ä½¿ç”¨ OpenZeppelin çš„ `ReentrancyGuard`
- å…³é”®å‡½æ•°æ·»åŠ  `nonReentrant` ä¿®é¥°ç¬¦
- çŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰å®Œæˆ

### 2. æ•´æ•°æº¢å‡ºé˜²æŠ¤
- ä½¿ç”¨ Solidity 0.8+ å†…ç½®æº¢å‡ºæ£€æŸ¥
- å…³é”®è®¡ç®—ä½¿ç”¨ SafeMath éªŒè¯
- è¾¹ç•Œæ¡ä»¶æ£€æŸ¥

### 3. è®¿é—®æŽ§åˆ¶
- åŸºäºŽè§’è‰²çš„æƒé™ç®¡ç†
- å‡½æ•°çº§åˆ«çš„è®¿é—®æŽ§åˆ¶
- æ•æ„Ÿæ“ä½œçš„å¤šé‡éªŒè¯

### 4. ç´§æ€¥æŽ§åˆ¶
- ç´§æ€¥æš‚åœæœºåˆ¶
- ç®¡ç†å‘˜ç´§æ€¥å¹²é¢„èƒ½åŠ›
- çŠ¶æ€å›žæ»šå’Œæ¢å¤åŠŸèƒ½

## ðŸ“ æŽ¥å£è®¾è®¡

### ICrowdsale æ ¸å¿ƒæŽ¥å£

```solidity
interface ICrowdsale {
    // çŠ¶æ€æŸ¥è¯¢
    function getCurrentPhase() external view returns (CrowdsalePhase);
    function getCrowdsaleConfig() external view returns (CrowdsaleConfig memory);
    function getCrowdsaleStats() external view returns (CrowdsaleStats memory);
    
    // çŠ¶æ€ç®¡ç†
    function startPresale() external;
    function startPublicSale() external;
    function finalizeCrowdsale() external;
    
    // ç´§æ€¥æŽ§åˆ¶
    function emergencyPause() external;
    function emergencyResume() external;
    
    // é…ç½®ç®¡ç†
    function updateConfig(CrowdsaleConfig calldata _config) external;
}
```

## ðŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•è¦†ç›–

**çŠ¶æ€ç®¡ç†æµ‹è¯•**:
- åˆå§‹çŠ¶æ€éªŒè¯
- çŠ¶æ€è½¬æ¢é€»è¾‘
- éžæ³•è½¬æ¢æ‹’ç»
- è¾¹ç•Œæ¡ä»¶å¤„ç†

**æ—¶é—´æŽ§åˆ¶æµ‹è¯•**:
- æ—¶é—´çª—å£éªŒè¯
- è‡ªåŠ¨è½¬æ¢è§¦å‘
- æ—¶é—´è¾¹ç•Œå¤„ç†
- è¿‡æœŸçŠ¶æ€æ£€æŸ¥

**æƒé™æŽ§åˆ¶æµ‹è¯•**:
- è§’è‰²æƒé™éªŒè¯
- æœªæŽˆæƒè®¿é—®æ‹’ç»
- æƒé™è½¬ç§»æµ‹è¯•
- ç´§æ€¥æƒé™æµ‹è¯•

### 2. é›†æˆæµ‹è¯•åœºæ™¯

**å®Œæ•´æµç¨‹æµ‹è¯•**:
- ä¼—ç­¹ç”Ÿå‘½å‘¨æœŸæµ‹è¯•
- å¤šåˆçº¦äº¤äº’æµ‹è¯•
- å¼‚å¸¸æƒ…å†µå¤„ç†
- è¾¹ç•Œæ¡ä»¶éªŒè¯

### 3. æ¨¡ç³Šæµ‹è¯•

**éšæœºè¾“å…¥æµ‹è¯•**:
- éšæœºæ—¶é—´å‚æ•°
- éšæœºé…ç½®ç»„åˆ
- è¾¹ç•Œå€¼æµ‹è¯•
- å¼‚å¸¸è¾“å…¥å¤„ç†

## ðŸ“ˆ Gasä¼˜åŒ–ç­–ç•¥

### 1. å­˜å‚¨ä¼˜åŒ–
- ç»“æž„ä½“æ‰“åŒ…ä¼˜åŒ–
- çŠ¶æ€å˜é‡å¸ƒå±€ä¼˜åŒ–
- å‡å°‘å­˜å‚¨è¯»å†™æ“ä½œ

### 2. è®¡ç®—ä¼˜åŒ–
- é¿å…é‡å¤è®¡ç®—
- ä½¿ç”¨ä½è¿ç®—ä¼˜åŒ–
- æ‰¹é‡æ“ä½œæ”¯æŒ

### 3. äº‹ä»¶ä¼˜åŒ–
- ç´¢å¼•å­—æ®µä¼˜åŒ–
- äº‹ä»¶æ•°æ®æœ€å°åŒ–
- æ‰¹é‡äº‹ä»¶å‘å°„

## ðŸš€ éƒ¨ç½²å’ŒéªŒè¯

### 1. éƒ¨ç½²è„šæœ¬
- çŽ¯å¢ƒé…ç½®æ£€æŸ¥
- ä¾èµ–åˆçº¦éªŒè¯
- åˆå§‹åŒ–å‚æ•°è®¾ç½®
- éƒ¨ç½²åŽéªŒè¯

### 2. éªŒè¯æ­¥éª¤
- åˆçº¦çŠ¶æ€éªŒè¯
- æƒé™é…ç½®æ£€æŸ¥
- é›†æˆæµ‹è¯•æ‰§è¡Œ
- åŠŸèƒ½å®Œæ•´æ€§éªŒè¯

## ðŸ“š æœ€ä½³å®žè·µ

### 1. ä»£ç è´¨é‡
- éµå¾ª Solidity ç¼–ç è§„èŒƒ
- å®Œæ•´çš„ NatSpec æ–‡æ¡£
- é”™è¯¯å¤„ç†å’Œå›žæ»šæœºåˆ¶
- ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§

### 2. å®‰å…¨è€ƒè™‘
- æœ€å°æƒé™åŽŸåˆ™
- å¤šé‡éªŒè¯æœºåˆ¶
- ç´§æ€¥å“åº”èƒ½åŠ›
- å®¡è®¡å‹å¥½çš„ä»£ç ç»“æž„

### 3. å¯æ‰©å±•æ€§
- æ¨¡å—åŒ–æŽ¥å£è®¾è®¡
- å‡çº§é¢„ç•™æŽ¥å£
- é…ç½®å‚æ•°åŒ–
- åŠŸèƒ½æ’ä»¶åŒ–æ”¯æŒ

---

## ðŸ“‹ å®žæ–½æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º ICrowdsale æŽ¥å£å®šä¹‰
- [ ] å®žçŽ° CrowdsaleConstants å¸¸é‡æ–‡ä»¶
- [ ] å¼€å‘ TokenCrowdsale ä¸»åˆçº¦
- [ ] ç¼–å†™å®Œæ•´çš„å•å…ƒæµ‹è¯•
- [ ] å®žçŽ°éƒ¨ç½²è„šæœ¬
- [ ] æ‰§è¡Œé›†æˆæµ‹è¯•
- [ ] è¿›è¡Œå®‰å…¨å®¡æŸ¥
- [ ] å®Œæˆæ–‡æ¡£ç¼–å†™

---

**ä¸‹ä¸€æ­¥**: å®žçŽ° Step 2.2 ä»£å¸è´­ä¹°å’Œå®šä»·æœºåˆ¶ï¼Œåœ¨å½“å‰æž¶æž„åŸºç¡€ä¸Šæ·»åŠ å…·ä½“çš„è´­ä¹°é€»è¾‘å’Œå®šä»·ç­–ç•¥ã€‚
